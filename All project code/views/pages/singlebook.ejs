<%- include ('../partials/head') %>
<%- include ('../partials/menu') %>


      <% try {
        const m = 30; //change this variable to alter # lines rendered per page
        const startLine = (currentPage - 1) * m;
        const endLine = startLine + m;
        const page1 = book.contents.split('\n').slice(startLine, endLine).join('');
        const page2 = book.contents.split('\n').slice(startLine+m, endLine+m).join('');

      %>
      
      <main>
        <!-- The following 2 divs are an attempt to pass ejs variables into 
          javascript without my syntax error detection getting a false positive -->
        <div hidden id="current_page"><%=currentPage%></div>
        <div hidden id="book_id"><%=book.id%></div>

  <div class="col-container">
    <div class="col-9">
      <div class="container" id="annotation_pages">
        <h1>Book </h1>
        <p id="book_display">
          <%= page1+page2 %>
        </p>
          
          <div style="display: flex; justify-content: center;">
          <b>Page <%=currentPage%>/<%=currentPage + 1%></b>
        </div>
        <div style="display: flex; justify-content: center;">
          
          <button class="btn btn-primary" onclick="create_annotation()">Annotate</button>
          <form style="padding: 2px" method="GET" action="/books">
            <button class="btn btn-warning" type="submit">Back</button>
          </form>
          <form style="padding: 2px" method="GET" action="/changePage/<%=book.id%>/<%=currentPage-1%>">
            <button class="btn btn-primary" type="submit">Prev Page</button>
          </form>
          <form style="padding: 2px" method="GET" action="/changePage/<%=book.id%>/<%=currentPage+1%>">
            <button class="btn btn-primary" type="submit">Next Page</button>
          </form>
          <form style="padding: 2px" method="GET" id="skipToForm">
            <button class="btn btn-info" type="button" onclick="skipTo()">Skip to</button>
            <input style="width: 40px"pattern="[0-9]+" type="text" id="skipToInput" name="skipToPage">
          </form>
        </div>

      </div>
    </div>
    <div class="col-3">
      <div class="row justify-content-md-center" id="cur_annotation_row">
        <h6>current annotation</h6>
        <div class="container-fluid" id="current_annotation_box"></div>
      </div>
      <div class="row justify-content-md-center" id="comment_section_row">
        <h6 id="comments_header">comments</h6>
        <div class="container-fluid" id="comment_section"></div>
      </div>
      <div class="row justify-content-md-center" id="add_comment_row">
        <input type="text" id="add_comment_text">
        <button onclick="add_comment(add_comment_text.value)" id="add_comment_btn">add comment</button>
      </div> 
    </div>
  </div>

  
      <% } catch (error) { %>
        <p>Error: <%= error.message %></p>
      <% } %>
</main>

      

  


<%- include ('../partials/footer') %>

<script>
let annotations = [];
let cur_annotation;
let book_contents;
let page_length;
let PAGE_NUMBER; 
let BOOK_ID;

console.log(BOOK_ID);
console.log(PAGE_NUMBER);
document.querySelector("main").onload = onload_test();

function onload_test(){
  PAGE_NUMBER = Number(document.getElementById('current_page').innerHTML);
  BOOK_ID = Number(document.getElementById('book_id').innerHTML);
  book_contents = document.getElementById('book_display').innerHTML;
  page_length = book_contents.length;
  console.log(BOOK_ID);
  console.log(PAGE_NUMBER);
  console.log(page_length);
}

function set_cur_annotation(id){
  cur_annotation = annotations.find(ann => {return ann.id == id});
  refresh_comments();
}

function removeAllChildren(node){
  while(node.hasChildNodes()){
    node.removeChild(node.firstChild);
  }
}

function add_comment(text){
  // FIX ME: Push comment to database
  cur_annotation.comments.push(text);
  refresh_comments();
}

function largest_id(array){
  let largest = -1;
  array.forEach(element => {
    if(element.id > largest){
      largest = element.id;
    }
  });
  return largest;
}

function refresh_comments(){
  const comments_section = document.getElementById('comment_section');
  const annotation_box = document.getElementById('current_annotation_box');

  //clear old comments
  removeAllChildren(comments_section);

  //refresh annotation_box
  if(cur_annotation.text_elm.innerHTML == null){
    annotation_box.innerHTML = "none";
    return;
  }
  annotation_box.innerHTML = cur_annotation.text_elm.innerHTML;

  //display this annotated text's comments
    // FIX ME: query database for what comments this annotation has

  cur_annotation.comments.forEach(comment => {
    new_comment = document.createElement('div');
    new_comment.classList.add('card');
    new_comment.classList.add('comment');
    new_comment.innerHTML = comment;

    comments_section.appendChild(new_comment);
  });
}

function create_annotation(){
  console.log("creating annotations");
  const highlightResponce = highlightSelectedText();
  var new_annotation;
  fetch('/create_annotation', {
    method: "POST",
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      book_id: BOOK_ID,
      page_number: PAGE_NUMBER,
      start_index: highlightResponce.start_index, 
      end_index: highlightResponce.end_index 
    })
  })
  .then(responce => {
    responce.json().then( (result) =>{
      new_annotation = {
        id:result.id,
        text_elm: highlightResponce.text_elm,
        comments: [],
        start_index: result.start_index, 
        end_index: result.end_index 
      };
      annotations.push(new_annotation);
      new_annotation.text_elm.setAttribute('onclick', `set_cur_annotation(${new_annotation.id})`);
      cur_annotation = new_annotation;
      refresh_comments()
    });
  });
}

function highlight_annotations(){
  ranges_to_highlight = [];
  annotations.forEach((ann) =>{
    ranges_to_highlight.push([ann.start_index,ann.end_index]);
  });
  highlightRanges(ranges_to_highlight);
}

function highlightRanges(ranges_to_highlight){
  //expects the ranges to not overlap

  //ranges_to_highlight.sortbylargestend

  const book_display = document.getElementById('book_display');
  console.log('start array');
  console.log(ranges_to_highlight);
  let text = book_display.textContent;
  ranges_to_highlight.sort((a,b) => {return b[1]-a[1]});
  console.log('sorted array');
  console.log(ranges_to_highlight);

  ranges_to_highlight.forEach((range)=>{
    highlight_start = range[0];
    highlight_end = range[1];
    prev_version_begining = text.slice(0,highlight_start);
    prev_version_end = text.slice(highlight_end);
    text_to_highlight = text.slice(highlight_start,highlight_end);
    text = prev_version_begining +'<mark>'+text_to_highlight+'</mark>'+prev_version_end;
  });
  book_display.innerHTML =text;
}

function highlightSelectedText() {
  var selection = window.getSelection();
  if (selection.rangeCount) {
    var range = selection.getRangeAt(0).cloneRange();
    var highlight = document.createElement('span');
    highlight.classList.add('highlight');
    range.surroundContents(highlight);
    selection.removeAllRanges();
    selection.addRange(range);
    return {
      text_elm: highlight,
      start_index: book_contents.search(highlight.innerHTML), 
      end_index: book_contents.search(highlight.innerHTML)+highlight.innerHTML.length
    };
   
  }
}

function skipTo() {
    var form = document.getElementById('skipToForm');
    var input = document.getElementById('skipToInput');
    var value = input.value;
    form.action = '/changePage/<%=book.id%>/' + value;
    form.submit();
  }

</script>

<style>


.row{
  padding-right: 5px;
  padding-left: 5px;
  padding-top: 0;
  padding-bottom: 0;
  text-align: center;
}

#current_annotation_box{
  border: 1px solid #000000;
  padding: 0px;
  overflow-y: scroll;
  height: 18vh;
  width: 100%;
}

#comment_section{
  border: 1px solid #000000;
  height: 30vh;
  overflow-y: scroll;
}

#comments_header{
  height: 5%;
  width: 100%;
  position: relative;
  top: 10px;
}

#comment_section_row {
  height: 45%;
  padding-top: 0;
  padding-bottom: 0;
}
#add_comment_row{
  height: 10%;
}
#cur_annotation_row{
  height: 25%;
}

#add_comment_btn, #add_comment_text{
  width: 100%;
}

.col-container {
  display: flex;
  flex-direction: row;
  width: 100%;
}
.col-9{
  flex-shrink: 1;
}
.col-3 {
  padding: 20px;
  flex-shrink: 1;
}

#annotation_pages{
  padding: 20px;
  height: 93vh;
}
#book_display{ 
  height: 67%;
  overflow-y: scroll;
}
body{
  position: relative;
  min-height: 100vh; 
  overflow: hidden;
}

main{
  padding-top: 10vh; /*equal header height*/
  padding-bottom: 4vh; /*equal footer height*/
}

header{
  position: absolute;
  width: 100%;
  height: 10vh; 
}

footer{
  position: absolute;
  width: 100%;
  bottom: 0;
  height: 4vh; 
}

.highlight {
  background-color: yellow;
}
</style>


<%- include ('../partials/footer') %>